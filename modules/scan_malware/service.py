#!/usr/bin/env python3
"""
Malware scanning service (FastAPI router).

This module currently exposes heuristic scanning logic. Replace the
`HeuristicMalwareScanner` with an enterprise-grade engine when available.
"""
from __future__ import annotations

import logging
from datetime import datetime, timezone
from typing import Any, Dict, Optional

from fastapi import APIRouter, File, HTTPException, UploadFile

from core.config import load_config
from core.db.mongodb import get_db, reset_db
from modules.scan_malware.scanner import HeuristicMalwareScanner
from modules.scan_malware.schemas import MalwareHealthOut, MalwareReloadOut, MalwareScanOut

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/malware", tags=["malware"])

_cfg: Dict[str, Any] = {}
_mcfg: Dict[str, Any] = {}
_scanner: Optional[HeuristicMalwareScanner] = None
_db = None  # pymongo.database.Database | None


def _load_everything() -> tuple[Dict[str, Any], Dict[str, Any], HeuristicMalwareScanner, Optional[Any]]:
    cfg = load_config()
    malware_cfg = cfg.get("malware", {}) or {}
    scanner = HeuristicMalwareScanner(malware_cfg)

    db = None
    try:
        db = get_db(cfg)
    except Exception as exc:
        logger.warning("Mongo logging unavailable for malware scans: %s", exc)
        db = None

    return cfg, malware_cfg, scanner, db


def _malware_logging_enabled() -> bool:
    return bool(_mcfg.get("logging", {}).get("collection_scans"))


def _mongo_log_scan(result: Dict[str, Any]) -> None:
    if _db is None or not _malware_logging_enabled():
        return

    logging_cfg = _mcfg.get("logging", {})
    only_positives = bool(logging_cfg.get("log_only_positives", True))
    if only_positives and result["label"] == 0:
        return

    try:
        doc = {
            "ts": datetime.now(timezone.utc),
            "label": int(result["label"]),
            "probability": float(result["probability"]),
            "threshold": float(result["threshold"]),
            "sha256": result["sha256"],
            "size": result["size"],
            "indicators": result.get("indicators", []),
            "features": result.get("features", {}),
            "filename": result.get("filename"),
            "content_type": result.get("content_type"),
            "source": "api/malware",
        }
        collection = logging_cfg.get("collection_scans", "malware_scans")
        _db[collection].insert_one(doc)
        logger.info("Logged malware scan result to Mongo: %s", collection)
    except Exception:
        logger.exception("Failed to log malware scan result to Mongo")


@router.get("/health", response_model=MalwareHealthOut)
def health() -> MalwareHealthOut:
    return MalwareHealthOut(
        scanner_initialized=_scanner is not None,
        threshold=float(_mcfg.get("threshold", 0.6)),
        max_bytes=int((_mcfg.get("scanner") or {}).get("max_bytes", 20 * 1024 * 1024)),
        mongodb_enabled=bool(_cfg.get("mongodb", {}).get("enabled", False)),
        mongodb_connected=_db is not None,
        collection=_mcfg.get("logging", {}).get("collection_scans"),
    )


@router.post("/reload", response_model=MalwareReloadOut)
def reload_runtime() -> MalwareReloadOut:
    global _cfg, _mcfg, _scanner, _db

    try:
        reset_db()
    except Exception:
        pass

    _cfg, _mcfg, _scanner, _db = _load_everything()

    mongo_ok = _db is not None
    if _db is not None:
        try:
            _db.command("ping")
        except Exception as exc:
            mongo_ok = False
            logger.warning("Mongo ping failed after reload: %s", exc)

    return MalwareReloadOut(
        ok=True,
        threshold=float(_mcfg.get("threshold", 0.6)),
        scanner_config={
            "max_bytes": (_mcfg.get("scanner") or {}).get("max_bytes"),
            "high_entropy_threshold": (_mcfg.get("scanner") or {}).get("high_entropy_threshold"),
            "mongo_ok": mongo_ok,
        },
    )


@router.post("/scan", response_model=MalwareScanOut)
async def scan(file: UploadFile = File(...)) -> MalwareScanOut:
    if _scanner is None:
        raise HTTPException(status_code=503, detail="Malware scanner not initialized")

    data = await file.read()
    if not data:
        raise HTTPException(status_code=400, detail="Uploaded file is empty")

    result = _scanner.scan(
        data=data,
        filename=file.filename,
        content_type=file.content_type,
    )
    _mongo_log_scan(result)
    return MalwareScanOut(**result)


# Initialize globals on import
_cfg, _mcfg, _scanner, _db = _load_everything()
