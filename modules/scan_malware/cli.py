import argparse
import json
from pathlib import Path

from core.config import load_config
from core.logging import setup_logging
from modules.scan_malware.scanner import HeuristicMalwareScanner


def main(argv=None):
    parser = argparse.ArgumentParser(prog="malware", description="Malware scanning helper CLI")
    parser.add_argument("file", help="Path to file to scan")
    parser.add_argument("--config", default="config/base.yaml", help="Config file to load (default: %(default)s)")
    parser.add_argument("--pretty", action="store_true", help="Pretty-print JSON output")

    args = parser.parse_args(argv)
    setup_logging("config/logging.yaml")

    file_path = Path(args.file)
    if not file_path.exists() or not file_path.is_file():
        raise SystemExit(f"File not found: {file_path}")

    cfg = load_config(args.config)
    scanner = HeuristicMalwareScanner(cfg.get("malware", {}))
    data = file_path.read_bytes()
    result = scanner.scan(data, filename=file_path.name)

    if args.pretty:
        print(json.dumps(result, indent=2, default=str))
    else:
        print(json.dumps(result, separators=(",", ":")))


if __name__ == "__main__":
    main()
