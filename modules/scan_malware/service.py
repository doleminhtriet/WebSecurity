#!/usr/bin/env python3
"""
Malware scanning service (FastAPI router).

This module currently exposes heuristic scanning logic. Replace the
`HeuristicMalwareScanner` with an enterprise-grade engine when available.
"""
from __future__ import annotations

import logging
from datetime import datetime, timezone
from typing import Any, Dict, Optional

from fastapi import APIRouter, File, HTTPException, UploadFile

from core.config import load_config
from core.db.mongodb import get_db, reset_db
from modules.scan_malware.scanner import HeuristicMalwareScanner
from modules.scan_malware.clamav_scanner import ClamAVScanner
from modules.scan_malware.schemas import MalwareHealthOut, MalwareReloadOut, MalwareScanOut

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/malware", tags=["malware"])

_cfg: Dict[str, Any] = {}
_mcfg: Dict[str, Any] = {}
_scanner: Optional[object] = None
_db = None  # pymongo.database.Database | None
_engine = "heuristic"


def _load_everything() -> tuple[Dict[str, Any], Dict[str, Any], Optional[object], Optional[Any], str]:
    cfg = load_config()
    malware_cfg = cfg.get("malware", {}) or {}
    requested_engine = (malware_cfg.get("engine") or "heuristic").lower()
    engine = requested_engine
    scanner = None
    try:
        if requested_engine == "clamav":
            scanner = ClamAVScanner(malware_cfg)
        if scanner is None:
            raise RuntimeError("ClamAV scanner unavailable")
    except Exception as exc:
        logger.warning("Failed to initialize malware scanner (%s): %s", requested_engine, exc)
        # Fallback to heuristic if clamav is not available
        try:
            scanner = HeuristicMalwareScanner(malware_cfg)
            engine = "heuristic"
            logger.info("Fell back to heuristic malware scanner.")
        except Exception as inner_exc:
            logger.exception("Failed to initialize heuristic malware scanner fallback: %s", inner_exc)
            scanner = None

    db = None
    try:
        db = get_db(cfg)
    except Exception as exc:
        logger.warning("Mongo logging unavailable for malware scans: %s", exc)
        db = None

    return cfg, malware_cfg, scanner, db, engine


def _malware_logging_enabled() -> bool:
    return bool(_mcfg.get("logging", {}).get("collection_scans"))


def _mongo_log_scan(result: Dict[str, Any]) -> None:
    if _db is None or not _malware_logging_enabled():
        return

    logging_cfg = _mcfg.get("logging", {})
    only_positives = bool(logging_cfg.get("log_only_positives", True))
    if only_positives and result["label"] == 0:
        return

    try:
        doc = {
            "ts": datetime.now(timezone.utc),
            "label": int(result["label"]),
            "probability": float(result["probability"]),
            "threshold": float(result["threshold"]),
            "sha256": result["sha256"],
            "size": result["size"],
            "indicators": result.get("indicators", []),
            "features": result.get("features", {}),
            "filename": result.get("filename"),
            "content_type": result.get("content_type"),
            "source": "api/malware",
        }
        collection = logging_cfg.get("collection_scans", "malware_scans")
        _db[collection].insert_one(doc)
        logger.info("Logged malware scan result to Mongo: %s", collection)
    except Exception:
        logger.exception("Failed to log malware scan result to Mongo")


@router.get("/health", response_model=MalwareHealthOut)
def health() -> MalwareHealthOut:
    return MalwareHealthOut(
        scanner_initialized=_scanner is not None,
        engine=_engine,
        threshold=float(getattr(_scanner, "threshold", _mcfg.get("threshold", 0.6))),
        max_bytes=getattr(_scanner, "max_bytes", None),
        mongodb_enabled=bool(_cfg.get("mongodb", {}).get("enabled", False)),
        mongodb_connected=_db is not None,
        collection=_mcfg.get("logging", {}).get("collection_scans"),
    )


@router.post("/reload", response_model=MalwareReloadOut)
def reload_runtime() -> MalwareReloadOut:
    global _cfg, _mcfg, _scanner, _db, _engine

    try:
        reset_db()
    except Exception:
        pass

    _cfg, _mcfg, _scanner, _db, _engine = _load_everything()

    mongo_ok = _db is not None
    if _db is not None:
        try:
            _db.command("ping")
        except Exception as exc:
            mongo_ok = False
            logger.warning("Mongo ping failed after reload: %s", exc)

    return MalwareReloadOut(
        ok=True,
        engine=_engine,
        threshold=float(getattr(_scanner, "threshold", _mcfg.get("threshold", 0.6))),
        scanner_config={
            "max_bytes": getattr(_scanner, "max_bytes", None),
            "high_entropy_threshold": (_mcfg.get("scanner") or {}).get("high_entropy_threshold"),
            "mongo_ok": mongo_ok,
            "clamav": {
                "host": (_mcfg.get("clamav") or {}).get("host"),
                "port": (_mcfg.get("clamav") or {}).get("port"),
                "unix_socket": (_mcfg.get("clamav") or {}).get("unix_socket"),
            },
        },
    )


@router.post("/scan", response_model=MalwareScanOut)
async def scan(file: UploadFile = File(...)) -> MalwareScanOut:
    if _scanner is None:
        raise HTTPException(status_code=503, detail="Malware scanner not initialized")

    data = await file.read()
    if not data:
        raise HTTPException(status_code=400, detail="Uploaded file is empty")

    try:
        result = _scanner.scan(
            data=data,
            filename=file.filename,
            content_type=file.content_type,
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(status_code=500, detail=str(exc))
    _mongo_log_scan(result)
    return MalwareScanOut(**result)


# Initialize globals on import
_cfg, _mcfg, _scanner, _db, _engine = _load_everything()
