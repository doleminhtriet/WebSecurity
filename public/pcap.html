<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PCAP Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --accent-1: #5b6ef1;
            --accent-2: #6e52b8;
            --muted: #6b7280;
            --bg: #f4f6fb;
            --card: #ffffff;
            --success: #28a745;
            --radius: 12px;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        body {
            background: linear-gradient(180deg, var(--bg), #eef2ff 60%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px;
            color: #111827;
        }

        .wrap {
            width: 100%;
            max-width: 1100px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), var(--card));
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            padding: 22px;
            backdrop-filter: blur(6px);
        }

        header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 18px;
        }

        .logo {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(99, 102, 241, 0.15);
            flex-shrink: 0;
        }

        h1 {
            font-size: 20px;
            margin: 0;
        }

        p.lead {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }

        .main {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 20px;
            margin-top: 18px;
        }

        .panel {
            background: var(--card);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.03);
        }

        .drop {
            border: 1px dashed rgba(99, 102, 241, 0.18);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.03), rgba(99, 102, 241, 0.01));
        }

        .file-label {
            display: inline-block;
            padding: 10px 16px;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            color: #fff;
            border-radius: 999px;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 6px 14px rgba(99, 102, 241, 0.12);
        }

        #file-input {
            display: none;
        }

        .meta {
            margin-top: 12px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 14px;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
            font-weight: 600;
            background: var(--accent-1);
            color: #fff;
        }

        .btn.ghost {
            background: transparent;
            color: var(--accent-2);
            border: 1px solid rgba(101, 84, 199, 0.12);
            font-weight: 600;
        }

        .btn.success {
            background: var(--success);
        }

        .loading {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            color: var(--muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid rgba(0, 0, 0, 0.06);
            border-top-color: var(--accent-2);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .content-panel {
            padding: 0;
        }

        .stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .stat {
            background: var(--card);
            padding: 12px;
            border-radius: 10px;
            min-width: 160px;
            flex: 1;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.03);
        }

        .stat .label {
            font-size: 12px;
            color: var(--muted);
        }

        .stat .value {
            font-weight: 700;
            font-size: 20px;
            margin-top: 6px;
        }

        section.h {
            margin-bottom: 16px;
        }

        h3 {
            margin: 0 0 10px 0;
            font-size: 15px;
            color: #111827;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #eef2ff;
            color: #374151;
        }

        th {
            font-weight: 600;
            color: var(--muted);
            background: transparent;
        }

        canvas {
            width: 100% !important;
            height: 160px !important;
            border-radius: 8px;
            background: transparent;
        }

        @media (max-width: 920px) {
            .main {
                grid-template-columns: 1fr;
            }

            .stats .stat {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('authToken');
        if(!token){
            window.location.href = '/app/login/login.html';
        }else{
            fetch('/auth/me',{headers:{Authorization:'Bearer '+token}})
              .then(r=>r.ok?r.json():Promise.reject())
              .catch(()=>{localStorage.removeItem('authToken');window.location.href='/app/login/login.html';});
        }
    </script>
    <div class="wrap" role="main">
        <header>
            <div class="logo">PC</div>
            <div>
                <h1>PCAP Analyzer</h1>
            </div>
        </header>

        <div class="main">
            <div class="panel" aria-labelledby="upload-title">
                <h3 id="upload-title">Upload</h3>
                <div class="drop" id="dropzone" aria-hidden="false">
                    <p style="margin:0;color:var(--muted)">Drag & drop or choose a file</p>
                    <label class="file-label" for="file-input">Choose PCAP</label>
                    <input id="file-input" type="file" accept=".pcap,.pcapng" />
                    <p class="meta" id="file-name">No file selected</p>

                    <div class="btn-row">
                        <button class="btn success" id="analyze-btn" style="display:none">Analyze</button>
                        <button class="btn ghost" id="clear-btn" type="button">Clear</button>
                    </div>

                    <div id="loading" class="loading" style="display:none">
                        <div class="spinner" aria-hidden="true"></div>
                        <div>Analyzing...</div>
                    </div>
                </div>

                <div style="margin-top:14px;color:var(--muted);font-size:13px">
                    <strong>Note:</strong> Analysis results are automatically saved to MongoDB.
                </div>
            </div>

            <div class="content-panel">
                <div id="results" style="display:none">
                    <div class="stats" id="stats"></div>

                    <div class="panel" style="padding:12px;margin-bottom:12px">
                        <h3>Protocol Distribution</h3>
                        <table id="protocols"></table>
                    </div>

                    <div class="panel" style="padding:12px;margin-bottom:12px">
                        <h3>Top Talkers (Source IPs)</h3>
                        <table id="top-talkers"></table>
                    </div>

                    <div class="panel" style="padding:12px;margin-bottom:12px">
                        <h3>Charts</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div>
                                <small style="color:var(--muted)">Protocol</small>
                                <canvas id="protocolPie"></canvas>
                            </div>
                            <div>
                                <small style="color:var(--muted)">Top Talkers</small>
                                <canvas id="topTalkersBar"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>First 10 Packets</h3>
                        <div style="overflow:auto;max-height:260px">
                            <table id="packet-details"></table>
                        </div>
                    </div>
                </div>

                <div id="empty-state" class="panel" style="margin-top:12px">
                    <h3 style="margin-bottom:6px">No data yet</h3>
                    <p class="lead" style="margin-top:0;color:var(--muted)">Choose a pcap file to see analysis results.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = [];
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loadingEl = document.getElementById('loading');
        const resultsEl = document.getElementById('results');
        const emptyEl = document.getElementById('empty-state');
        const dropzone = document.getElementById('dropzone');

        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0] ?? null;
            if (selectedFile) {
                fileName.textContent = 'Selected: ' + selectedFile.name;
                analyzeBtn.style.display = 'inline-block';
            } else {
                fileName.textContent = 'No file selected';
                analyzeBtn.style.display = 'none';
            }
        });

        clearBtn.addEventListener('click', () => {
            fileInput.value = '';
            selectedFile = null;
            fileName.textContent = 'No file selected';
            analyzeBtn.style.display = 'none';
            resultsEl.style.display = 'none';
            emptyEl.style.display = 'block';
            destroyCharts();
        });

        analyzeBtn.addEventListener('click', analyzeFile);
        dropzone.addEventListener('dragenter', handleDrag);
        dropzone.addEventListener('dragover', handleDrag);
        dropzone.addEventListener('dragleave', handleDragLeave);
        dropzone.addEventListener('drop', handleDrop);
        window.addEventListener('dragover', preventWindowDrop, false);
        window.addEventListener('drop', preventWindowDrop, false);

        function preventWindowDrop(e) {
            e.preventDefault();
        }

        function handleDrag(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('dragging');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragging');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragging');
            const file = e.dataTransfer?.files?.[0];
            if (!file) return;
            const lower = file.name.toLowerCase();
            if (!lower.endsWith('.pcap') && !lower.endsWith('.pcapng')) {
                alert('Please drop a .pcap or .pcapng file.');
                return;
            }
            selectedFile = file;
            fileName.textContent = 'Selected: ' + file.name;
            analyzeBtn.style.display = 'inline-block';
        }

        async function analyzeFile() {
            if (!selectedFile) return;
            loadingEl.style.display = 'flex';
            resultsEl.style.display = 'none';
            emptyEl.style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const resp = await fetch('/pcap/analyze', { method: 'POST', body: formData });
                if (!resp.ok) {
                    let detail = '';
                    try {
                        const errData = await resp.json();
                        detail = errData?.detail ? ': ' + errData.detail : '';
                    } catch (e) { /* ignore parse errors */ }
                    throw new Error('Server error ' + resp.status + detail);
                }
                const data = await resp.json();
                if (!data?.basic_stats) throw new Error('Analyzer returned no statistics.');
                displayResults(data);
            } catch (err) {
                alert('Error: ' + (err.message || err));
                resultsEl.style.display = 'none';
                emptyEl.style.display = 'block';
                destroyCharts();
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function destroyCharts() {
            charts.forEach(c => { try { c.destroy(); } catch (e) {} });
            charts = [];
        }

        function displayResults(data) {
            destroyCharts();

            const statsEl = document.getElementById('stats');
            statsEl.innerHTML = '';
            const stats = [
                { label: 'Total Packets', value: data.basic_stats.total_packets },
                { label: 'Duration (s)', value: data.basic_stats.duration },
                { label: 'Unique IPs', value: data.basic_stats.unique_ips },
                { label: 'Total Size', value: data.basic_stats.total_bytes + ' bytes' },
            ];
            stats.forEach(s => {
                const div = document.createElement('div');
                div.className = 'stat';
                div.innerHTML = `<div class="label">${s.label}</div><div class="value">${s.value}</div>`;
                statsEl.appendChild(div);
            });

            const protocolsTable = document.getElementById('protocols');
            let protHtml = '<tr><th>Protocol</th><th>Count</th><th>Percentage</th></tr>';
            const protocolStats = data.protocol_stats || {};
            const totalPackets = data.basic_stats.total_packets || 0;
            for (const [p, count] of Object.entries(protocolStats)) {
                const pct = totalPackets ? ((count / totalPackets) * 100).toFixed(1) : '0.0';
                protHtml += `<tr><td>${p}</td><td>${count}</td><td>${pct}%</td></tr>`;
            }
            protocolsTable.innerHTML = protHtml;

            const talkersTable = document.getElementById('top-talkers');
            let talkHtml = '<tr><th>IP</th><th>Packets</th></tr>';
            (data.top_talkers || []).forEach(([ip, count]) => {
                talkHtml += `<tr><td>${ip}</td><td>${count}</td></tr>`;
            });
            talkersTable.innerHTML = talkHtml;

            const packetsTable = document.getElementById('packet-details');
            let pkHtml = '<tr><th>#</th><th>Time</th><th>Src</th><th>Dst</th><th>Proto</th><th>Size</th></tr>';
            (data.packet_details || []).slice(0, 10).forEach((p, i) => {
                pkHtml += `<tr><td>${i + 1}</td><td>${p.time}</td><td>${p.source}</td><td>${p.destination}</td><td>${p.protocol}</td><td>${p.size}</td></tr>`;
            });
            packetsTable.innerHTML = pkHtml;

            const protocolLabels = Object.keys(protocolStats);
            const protocolCounts = Object.values(protocolStats);
            const ctxP = document.getElementById('protocolPie').getContext('2d');
            charts.push(new Chart(ctxP, {
                type: 'pie',
                data: {
                    labels: protocolLabels,
                    datasets: [{
                        data: protocolCounts,
                        backgroundColor: ['#667eea', '#764ba2', '#28a745', '#ffce56', '#ff6384', '#36a2eb', '#fd7e14']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
            }));

            const talkLabels = (data.top_talkers || []).map(t => t[0]);
            const talkCounts = (data.top_talkers || []).map(t => t[1]);
            const ctxB = document.getElementById('topTalkersBar').getContext('2d');
            charts.push(new Chart(ctxB, {
                type: 'bar',
                data: { labels: talkLabels, datasets: [{ label: 'Packets', data: talkCounts, backgroundColor: '#667eea' }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            }));

            resultsEl.style.display = 'block';
            emptyEl.style.display = 'none';
        }
    </script>
</body>
</html>
